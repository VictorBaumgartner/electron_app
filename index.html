<!DOCTYPE html>
<html>

<head>
  <title>Electron with FastAPI</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 20px;
      background-color: #f7f7f7;
      color: #333;
    }

    h1 {
      font-size: 2em;
    }

    #counter-container {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }

    #count {
      font-size: 3em;
      font-weight: bold;
      color: #007BFF;
    }

    button {
      font-size: 1em;
      padding: 10px 15px;
      border-radius: 5px;
      border: 1px solid #ccc;
      cursor: pointer;
      background-color: #fff;
    }

    button:hover {
      background-color: #e9e9e9;
    }

    h2 {
      font-size: 1.2em;
      border-bottom: 1px solid #ccc;
      padding-bottom: 5px;
      margin-top: 30px;
    }

    #python-logs {
      background-color: #2b2b2b;
      color: #f1f1f1;
      border: 1px solid #ccc;
      padding: 10px;
      font-family: "Menlo", "Consolas", monospace;
      font-size: 0.9em;
      white-space: pre-wrap;
      word-break: break-all;
      height: 300px;
      overflow-y: scroll;
    }
  </style>
</head>

<body>
  <h1>Live Counter</h1>

  <div id="counter-container">
    <span id="count">Loading...</span>
    <button id="add-btn">Add +1</button>
    <button id="reset-btn">Reset</button>
  </div>

  <h2>Python Server Logs</h2>
  <pre id="python-logs">Waiting for server logs...</pre>

  <script>
    const { ipcRenderer } = require('electron');

    const countElement = document.getElementById('count');
    const addBtn = document.getElementById('add-btn');
    const resetBtn = document.getElementById('reset-btn');
    const logsElement = document.getElementById('python-logs');

    const apiUrl = 'http://127.0.0.1:8000';
    const wsUrl = 'ws://127.0.0.1:8000/ws';

    // Clear the initial logs message
    logsElement.innerText = '';

    // Function to add a message to the logs
    function logMessage(message) {
      logsElement.innerText += message;
      // Auto-scroll to the bottom
      logsElement.scrollTop = logsElement.scrollHeight;
    }

    // --- WebSocket for Live Updates ---
    function connectWebSocket() {
      const ws = new WebSocket(wsUrl);

      ws.onmessage = (event) => {
        console.log('Count update from WebSocket:', event.data);
        countElement.innerText = event.data;
      };

      ws.onopen = () => {
        console.log('WebSocket connection established.');
        logMessage('WebSocket connection established.\n');
      };

      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        logMessage(`WebSocket error. Is the server running?\n`);
      };

      ws.onclose = () => {
        console.log('WebSocket connection closed. Reconnecting in 2 seconds...');
        logMessage('WebSocket disconnected. Trying to reconnect...\n');
        // Try to reconnect after a short delay
        setTimeout(connectWebSocket, 2000);
      };
    }

    // Initial connection
    connectWebSocket();


    // --- Button Event Listeners ---
    addBtn.addEventListener('click', () => {
      fetch(`${apiUrl}/add`, { method: 'POST' })
        .catch(err => console.error('Error calling /add:', err));
    });

    resetBtn.addEventListener('click', () => {
      fetch(`${apiUrl}/reset`, { method: 'POST' })
        .catch(err => console.error('Error calling /reset:', err));
    });

    // --- IPC for Python Server Logs ---
    ipcRenderer.on('python-output', (event, message) => {
      console.log('Received Python log:', message);
      logMessage(message);
    });
  </script>
</body>

</html>